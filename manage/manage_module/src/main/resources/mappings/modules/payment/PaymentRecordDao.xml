<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heepay.manage.modules.payment.dao.PaymentRecordDao">
    
	<sql id="paymentRecordColumns">
		a.payment_id AS "paymentId",
		a.trans_no AS "transNo",
		a.merchant_id AS "merchantId",
		a.merchant_login_name AS "merchantLoginName",
		a.merchant_company AS "merchantCompany",
		a.product_code AS "productCode",
		a.pay_type AS "payType",
		a.trans_type AS "transType",
		a.status AS "status",
		a.description AS "description",
		a.update_time AS "updateTime",
		a.pay_amount AS "payAmount",
		a.pay_time AS "payTime",
		a.success_amount AS "successAmount",
		a.success_time AS "successTime",
		a.notify_url AS "notifyUrl",
		a.merchant_order_no AS "merchantOrderNo",
		a.bank_id AS "bankId",
		a.bank_name AS "bankName",
		a.bank_return_url AS "bankReturnUrl",
		a.bankcard_type AS "bankcardType",
		a.bankcard_no AS "bankcardNo",
		a.bankcard_owner AS "bankcardOwner",
		a.bankcard_owner_idcard AS "bankcardOwnerIdcard",
		a.bankcard_owner_mobile AS "bankcardOwnerMobile",
		a.bankcard_owner_type AS "bankcardOwnerType",
		a.bank_serial_no AS "bankSerialNo",
		a.authorization_code AS "authorizationCode",
		a.channel_code AS "channelCode",
		a.channel_name AS "channelName",
		substring(substring_index(a.channel_code, '_', 1),4) AS "channelPartner",
		a.channel_ref_no AS "channelRefNo",
		a.currency AS "currency",
		a.fee_type AS "feeType",
		a.fee_amount AS "feeAmount",
		a.operator AS "operator",
		a.coupon_amount AS "couponAmount",
		a.user_id AS "user.id",
		a.settle_cyc AS "settleCyc",
		a.check_status AS "checkStatus",
		a.create_time AS "createTime",
		a.wallet_merchant_id AS "walletMerchantId",
		a.merchant_user_id AS "merchantUserId",
		a.bank_serial_time AS "bankSerialTime",
		a.clear_date AS "clearDate",
		a.ext1 AS "ext1",
		a.ext2 AS "ext2",
		a.ext3 AS "ext3",
		a.request_ip AS "requestIp",
		a.request_user_ip AS "requestUserIp",
		a.version AS "version"
	</sql>
	
	<sql id="paymentRecordJoins">
	</sql>
    
	<select id="get" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		WHERE a.payment_id = #{paymentId}
	</select>
	<select id="getOneByGatewayId" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		WHERE a.status = 'SUCCES' and a.trans_no = #{transNo}
	</select>
	
	<select id="getFailedByGateWayId" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		WHERE a.status != 'SUCCES' and a.trans_no = #{transNo}
		
		ORDER BY payment_id DESC
	</select>
	
	<select id="getOne" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		WHERE a.trans_no = #{transNo}
	</select>
	
	
	
	<select id="getOneByChargeId" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		WHERE a.trans_type = 'CHARGE' And a.merchant_order_no = #{merchantOrderNo}
		
		ORDER BY payTime DESC
	</select>
	
	<select id="findList" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			
			<if test="paymentId != null and paymentId != ''">
				AND a.payment_id = #{paymentId}
			</if>
			<if test="transNo != null and transNo != ''">
				AND a.trans_no = #{transNo}
			</if>
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
			<if test="bankSerialNo != null and bankSerialNo != ''">
				AND a.bank_serial_no = #{bankSerialNo}
			</if>
			<if test="merchantLoginName != null and merchantLoginName != ''">
				AND a.merchant_login_name = #{merchantLoginName}
			</if>
			<if test="merchantCompany != null and merchantCompany != ''">
				AND a.merchant_company = #{merchantCompany}
			</if>
			<if test="productCode != null and productCode != ''">
				AND a.product_code = #{productCode}
			</if>
			<if test="payType != null and payType != ''">
				AND a.pay_type = #{payType}
			</if>
			<if test="transType != null and transType != '' and transType !='R0' and transType !='R1'">
				AND a.trans_type = #{transType}
			</if>
			<if test="transType == 'R0'">
				AND (a.trans_type = 'CHARGE' OR a.trans_type = 'REFUND' OR a.trans_type = 'BATPAY' OR a.trans_type = 'PAYMNT' OR a.trans_type = 'DPTPAY')
			</if>
			<if test="transType == 'R1'">
				AND a.trans_type != 'TRAFER'
			</if>
			<if test="status != 'R1'">
				AND a.status = #{status}
			</if>
			<if test="checkStatus != 'R1'">
				AND a.check_status = #{checkStatus}
			</if>
			<if test="beginCreateTime != null and endCreateTime != null">
				<if test="groupType == 1">
					AND a.pay_time BETWEEN date_format(#{beginCreateTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCreateTime},'%Y-%m-%d %H:%i:%s')
				</if>
				<if test="groupType == 2">
					AND a.success_time BETWEEN date_format(#{beginCreateTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCreateTime},'%Y-%m-%d %H:%i:%s')
				</if>
			</if>
			<if test="channelPartner != null and channelPartner != ''">
				AND a.channel_code like
				<if test="dbName == 'oracle'">'%'||#{channelPartner}||'%'</if>
				<if test="dbName == 'mssql'">'%'+#{channelPartner}+'%'</if>
				<if test="dbName == 'mysql'">concat('%',#{channelPartner},'%')</if>
			</if>
			<if test="merchantOrderNo != null and merchantOrderNo != ''">
				AND a.merchant_order_no = #{merchantOrderNo}
			</if>
			<if test="bankName != null and bankName != ''">
				AND a.bank_name = #{bankName}
			</if>
			<if test="bankcardType != '' and bankcardType != null">
				AND a.bankcard_type = #{bankcardType}
			</if>
		</where>
			<if test="sortOrder == 'ASC'">
	            ORDER BY payTime ASC
	        </if>
	        <if test="sortOrder == 'DESC'">
	            ORDER BY payTime DESC
	        </if>
	</select>

	<select id="getPaymentsByTransNo" resultType="PaymentRecord">
		SELECT
		<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<where>
			trans_no = #{transNo}
		</where>
		ORDER BY payTime DESC
	</select>
	
	<select id="findListByTransNo" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a 
		<where>
			trans_no = #{transNo} or merchant_order_no = #{transNo}
		</where>		
		 ORDER BY payTime DESC
	</select>
	
	<select id="findAllList" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO payment_record(
			payment_id,
			trans_no,
			merchant_id,
			merchant_login_name,
			merchant_company,
			product_code,
			type,
			status,
			description,
			update_time,
			pay_amount,
			pay_time,
			success_amount,
			success_time,
			merchant_order_no,
			bank_id,
			bank_name,
			bank_return_url,
			bankcard_type,
			bankcard_no,
			bankcard_owner,
			bankcard_owner_idcard,
			bankcard_owner_mobile,
			bankcard_owner_type,
			bank_serial_no,
			authorization_code,
			channel_code,
			channel_name,
			currency
		) VALUES (
			#{paymentId},
			#{transNo},
			#{merchantId},
			#{merchantLoginName},
			#{merchantCompany},
			#{productCode},
			#{type},
			#{status},
			#{description},
			#{updateTime},
			#{payAmount},
			#{payTime},
			#{successAmount},
			#{successTime},
			#{merchantOrderNo},
			#{bankId},
			#{bankName},
			#{bankReturnUrl},
			#{bankcardType},
			#{bankcardNo},
			#{bankcardOwner},
			#{bankcardOwnerIdcard},
			#{bankcardOwnerMobile},
			#{bankcardOwnerType},
			#{bankSerialNo},
			#{authorizationCode},
			#{channelCode},
			#{channelName},
			#{currency}
		)
	</insert>
	
	<update id="update">
		UPDATE payment_record SET 	
			payment_id = #{paymentId},
			trans_no = #{transNo},
			merchant_id = #{merchantId},
			merchant_login_name = #{merchantLoginName},
			merchant_company = #{merchantCompany},
			product_code = #{productCode},
			type = #{type},
			status = #{status},
			description = #{description},
			update_time = #{updateTime},
			pay_amount = #{payAmount},
			pay_time = #{payTime},
			success_amount = #{successAmount},
			success_time = #{successTime},
			merchant_order_no = #{merchantOrderNo},
			bank_id = #{bankId},
			bank_name = #{bankName},
			bank_return_url = #{bankReturnUrl},
			bankcard_type = #{bankcardType},
			bankcard_no = #{bankcardNo},
			bankcard_owner = #{bankcardOwner},
			bankcard_owner_idcard = #{bankcardOwnerIdcard},
			bankcard_owner_mobile = #{bankcardOwnerMobile},
			bankcard_owner_type = #{bankcardOwnerType},
			bank_serial_no = #{bankSerialNo},
			authorization_code = #{authorizationCode},
			channel_code = #{channelCode},
			channel_name = #{channelName},
			currency = #{currency}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		DELETE FROM payment_record
		WHERE id = #{id}
	</update>
	
	
	<update id="updatePaymentRecordFail">
        UPDATE payment_record SET   
            status = 'FAILED',
            update_time = now()
        WHERE payment_id = #{paymentId}
    </update>
    
    <update id="updatePaymentRecordPaying">
        UPDATE payment_record SET   
            status = 'PAYING',
            update_time = now()
        WHERE payment_id = #{paymentId}
    </update>
	
	<select id="getPaymentId" resultType="PaymentRecord">
		SELECT 
			max(a.payment_id) as paymentId
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
	</select>
	
	<select id="findUserWithdrawPage" resultType="PaymentRecord">
		SELECT 
			<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			a.product_code in('GRTX','GRCZ') 
			<if test="transNo != null and transNo != ''">
				AND a.trans_no = #{transNo} OR a.merchant_order_no = #{transNo}
			</if>
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
			<if test="transType != null and transType != '' ">
				AND a.trans_type = #{transType}
			</if>
			<if test="beginCreateTime != null and endCreateTime != null">
				AND a.pay_time BETWEEN date_format(#{beginCreateTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCreateTime},'%Y-%m-%d %H:%i:%s')
			</if>
			<if test="status == 'PROCES'">
				AND a.status != 'SUCCES' and a.status != 'FAILED' 
			</if>
			<if test="status == 'SUCCES'">
				AND a.status = 'SUCCES'
			</if>
			<if test="status == 'FAILED'">
				AND a.status = 'FAILED'
			</if>
		</where>
		ORDER BY payTime desc
	</select>

	<select id="findWithdrawDepositPage" resultType="PaymentRecord">
		SELECT
		<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			<if test="transType != null and transType != '' ">
				AND a.trans_type = #{transType}
			</if>
			<if test="productCode != null and productCode != '' ">
				AND a.product_code = #{productCode}
			</if>
			<if test="payType != null and payType != '' ">
				AND a.pay_type = #{payType}
			</if>
			<if test="status != null and status != '' ">
				AND a.status = #{status}
			</if>
			<if test="walletMerchantId != null and walletMerchantId != '' ">
				AND a.wallet_merchant_id = #{walletMerchantId}
			</if>
			<if test="merchantId != null and merchantId != '' ">
				AND a.merchant_id = #{merchantId}
			</if>
			<if test="transNo != null and transNo != '' ">
				AND a.trans_no = #{transNo}
			</if>
			<if test="merchantOrderNo != null and merchantOrderNo != '' ">
				AND a.merchant_order_no = #{merchantOrderNo}
			</if>
		</where>
		ORDER BY payTime desc
	</select>

	<select id="getPaymentsForRefundReport" resultType="PaymentRecord" parameterType="java.util.Map">
		select <include refid="paymentRecordColumns" />
		from payment_record a
		<where>
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
			<if test="merchantCompany != null and merchantCompany != ''">
				AND a.merchant_company like %#{merchantId}%
			</if>
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
		</where>
	</select>

	<select id="getOriPaymentsForRefundReport" resultType="PaymentRecord" parameterType="java.util.Map">
		select <include refid="paymentRecordColumns" />
		  from payment_record a
		 where a.payment_id in
		<foreach collection="paymentIds" item="paymentId" open="(" close=")" separator="," >
			#{paymentId}
		</foreach>
        <if test="merchantIds != null">
            and a.merchant_id in
            <foreach collection="merchantIds" item="merchantId" open="(" close=")" separator="," >
                #{merchantId}
            </foreach>
        </if>
		<if test="payType != null and payType != ''">
			and a.pay_type = #{payType}
		</if>
		<if test="channelPartner != null and channelPartner != ''">
			and a.channel_code like CONCAT('%',#{channelPartner},'%')
		</if>
		<if test="bankId != null and bankId != ''">
			and a.bank_id = #{bankId}
		</if>
	</select>

	<select id="findAggrPayPage" resultType="PaymentRecord">
		SELECT
		<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			a.product_code in('CP40','CP41')
			<if test="transType != null and transType != '' ">
				AND a.trans_type = #{transType}
			</if>
			<if test="productCode != null and productCode != '' ">
				AND a.product_code = #{productCode}
			</if>
			<if test="payType != null and payType != '' ">
				AND a.pay_type = #{payType}
			</if>
			<if test="status != null and status != '' ">
				AND a.status = #{status}
			</if>
			<if test="walletMerchantId != null and walletMerchantId != '' ">
				AND a.wallet_merchant_id = #{walletMerchantId}
			</if>
			<if test="merchantId != null and merchantId != '' ">
				AND a.merchant_id = #{merchantId}
			</if>
			<if test="transNo != null and transNo != '' ">
				AND a.trans_no = #{transNo}
			</if>
			<if test="merchantOrderNo != null and merchantOrderNo != '' ">
				AND a.merchant_order_no = #{merchantOrderNo}
			</if>
		</where>
		ORDER BY payTime desc
	</select>

	<select id="findQuickPage" resultType="PaymentRecord">
		SELECT
		<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			a.product_code in('CP54')
			<if test="transType != null and transType != '' ">
				AND a.trans_type = #{transType}
			</if>
			<if test="productCode != null and productCode != '' ">
				AND a.product_code = #{productCode}
			</if>
			<if test="payType != null and payType != '' ">
				AND a.pay_type = #{payType}
			</if>
			<if test="status != null and status != '' ">
				AND a.status = #{status}
			</if>
			<if test="walletMerchantId != null and walletMerchantId != '' ">
				AND a.wallet_merchant_id = #{walletMerchantId}
			</if>
			<if test="merchantId != null and merchantId != '' ">
				AND a.merchant_id = #{merchantId}
			</if>
			<if test="transNo != null and transNo != '' ">
				AND a.trans_no = #{transNo}
			</if>
			<if test="merchantOrderNo != null and merchantOrderNo != '' ">
				AND a.merchant_order_no = #{merchantOrderNo}
			</if>
		</where>
		ORDER BY payTime desc
	</select>


	<select id="findAggrPayList" resultType="PaymentRecord">
		SELECT
		<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			<if test="transNo != null">
				a.trans_no  in
				<foreach item="item" index="index" collection="transNo"
						 open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</where>
		ORDER BY payTime desc
	</select>

	<select id="findListByPayment" resultType="PaymentRecord">
		SELECT
		<include refid="paymentRecordColumns"/>
		FROM payment_record a
		<include refid="paymentRecordJoins"/>
		<where>
			<if test="transNo != null">
				AND a.trans_no = #{transNo}
			</if>
			<if test="payAmount != null">
				AND a.pay_amount = #{payAmount}
			</if>
			<if test="productCode != null">
				AND a.product_code = #{productCode}
			</if>
		</where>
		ORDER BY payTime desc
	</select>

</mapper>
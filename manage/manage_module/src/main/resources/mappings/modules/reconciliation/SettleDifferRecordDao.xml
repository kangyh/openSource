<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.heepay.manage.modules.reconciliation.dao.SettleDifferRecordDao" >

	<sql id="settleDifferRecordColumns">
		differ_id AS "differId",
		merchant_id AS "merchantId",
		payment_id AS "paymentId",
		trans_no AS "transNo",
		channel_code AS "channelCode",
		channel_name AS "channelName",
		success_amount AS "successAmount",
		request_amount AS "requestAmount",
		check_bath_no AS "checkBathno",
		settle_bath AS "settleBath",
		channel_type AS "channelType",
		product_code AS "productCode",
		product_name AS "productName",
		channle_no AS "channleNo",
		differ_type AS "differType",
		handle_result AS "handleResult",
		handle_message AS "handleMessage",
		error_date AS "errorDate",
		update_author AS "updateAuthor",
		operation_date AS "operationDate",
		fee_amount AS "feeAmount",
		cost_amount AS "costAmount",
		settle_amount_plan AS "settleAmountPlan",
		trans_type AS "transType",
		trans_status AS "transStatus",
		is_bill  AS "isBill",
		is_profit AS "isProfit",
		merchant_order_no AS "merchantOrderNo",
		success_time AS "successTime",
		pay_time AS "payTime",
		busi_time AS "busiTime",
		remark AS "remark",
		is_zip AS "isZip",
		agent_name AS "agentName",
		agent_code AS "agentCode",
		fee_way AS "feeWay",
		bankcard_type AS "bankcardType",
		merchant_name AS "merchantName",
		bank_seq AS "bankSeq",
		bank_name AS "bankName",
		bank_code AS "bankCode",
		channel_provider AS "channelProvider",
		pay_type AS "payType",
		account_no AS "accountNo",
		receipts_path AS "receiptsPath"
	</sql>

	<select id="findList" resultType="SettleDifferRecord">
		SELECT
		<include refid="settleDifferRecordColumns"/>
		FROM settle_differ_record
		<where>
			<!-- 通道对账日期 -->
			<if test="beginCheckTime != null and endCheckTime != null">
				AND error_date BETWEEN date_format(#{beginCheckTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCheckTime},'%Y-%m-%d %H:%i:%s')
			</if>


			<!-- 通道名称 -->
			<if test="channelName != null and channelName != ''">
				AND channel_name LIKE #{channelName}
			</if>

			<!-- 通道合作方-->
			<if test="channelCode != null and channelCode != ''">
				AND channel_code = #{channelCode}
			</if>
			<!-- 通道类型 -->
			<if test="channelType != null and channelType != ''">
				AND channel_type = #{channelType}
			</if>
			<!-- 交易类型 -->
			<if test="transType != null and transType != ''">
				AND trans_type = #{transType}
			</if>
			<!-- 差错类型 -->
			<if test="differType != null and differType != ''">
				AND differ_type = #{differType}
			</if>
			<!-- 支付单号-->
			<if test="paymentId != null and paymentId != ''">
				AND payment_id = #{paymentId}
			</if>
			<!-- 汇付宝订单号 -->
			<if test="transNo != null and transNo != ''">
				AND trans_no = #{transNo}
			</if>
			<!-- 对账批次号 -->
			<if test="checkBathno != null and checkBathno != ''">
				AND check_bath_no = #{checkBathno}
			</if>

			<!-- 处理结果 -->
			<if test="handleResult != null and handleResult != ''">
				AND handle_result = #{handleResult}
			</if>

			<!-- 处理意见 -->
			<if test="handleMessage != null and handleMessage != ''">
				AND handle_message LIKE '%${handleMessage}%'
			</if>

			<!-- 处理意见 2-->
			<if test="handleMessage != null and handleMessage != '' and QXCY !=null and QXCY != '' ">
				AND (handle_message LIKE '%${handleMessage}%' OR handle_message LIKE '%${QXCY}%')
			</if>


		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY differ_id DESC , ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY differ_id DESC
			</otherwise>
		</choose>
	</select>


	<select id="findListExcel" resultType="hashmap">
		SELECT
		<include refid="settleDifferRecordColumns"/>
		FROM settle_differ_record
		<where>
			<!-- 通道对账日期 -->
			<if test="beginCheckTime != null and endCheckTime != null">
				AND error_date BETWEEN date_format(#{beginCheckTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCheckTime},'%Y-%m-%d %H:%i:%s')
			</if>


			<!-- 通道名称 -->
			<if test="channelName != null and channelName != ''">
				AND channel_name LIKE #{channelName}
			</if>

			<!-- 通道合作方-->
			<if test="channelCode != null and channelCode != ''">
				AND channel_code = #{channelCode}
			</if>
			<!-- 通道类型 -->
			<if test="channelType != null and channelType != ''">
				AND channel_type = #{channelType}
			</if>
			<!-- 交易类型 -->
			<if test="transType != null and transType != ''">
				AND trans_type = #{transType}
			</if>
			<!-- 差错类型 -->
			<if test="differType != null and differType != ''">
				AND differ_type = #{differType}
			</if>
			<!-- 支付单号-->
			<if test="paymentId != null and paymentId != ''">
				AND payment_id = #{paymentId}
			</if>
			<!-- 汇付宝订单号 -->
			<if test="transNo != null and transNo != ''">
				AND trans_no = #{transNo}
			</if>
			<!-- 对账批次号 -->
			<if test="checkBathno != null and checkBathno != ''">
				AND check_bath_no = #{checkBathno}
			</if>

			<!-- 处理结果 -->
			<if test="handleResult != null and handleResult != ''">
				AND handle_result = #{handleResult}
			</if>

			<!-- 处理意见 -->
			<if test="handleMessage != null and handleMessage != ''">
				AND handle_message LIKE '%${handleMessage}%'
			</if>

			<!-- 处理意见 2-->
			<if test="handleMessage != null and handleMessage != '' and QXCY !=null and QXCY != '' ">
				AND (handle_message LIKE '%${handleMessage}%' OR handle_message LIKE '%${QXCY}%')
			</if>

		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY differ_id DESC , ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY differ_id DESC
			</otherwise>
		</choose>
	</select>

	<select id="getEntityById" resultType="com.heepay.manage.modules.reconciliation.entity.SettleDifferRecord">
		SELECT
		<include refid="settleDifferRecordColumns"/>
		FROM settle_differ_record
		WHERE differ_id=#{differId}
	</select>


	<update id="updateTime" parameterType="SettleDifferRecord" >
		update settle_differ_record
		<set >
			<if test="merchantId != null" >
				merchant_id = #{merchantId,jdbcType=INTEGER},
			</if>
			<if test="paymentId != null and paymentId != ''" >
				payment_id = #{paymentId,jdbcType=VARCHAR},
			</if>
			<if test="transNo != null and transNo != ''" >
				trans_no = #{transNo,jdbcType=VARCHAR},
			</if>
			<if test="channelCode != null and channelCode != ''" >
				channel_code = #{channelCode,jdbcType=VARCHAR},
			</if>
			<if test="channelName != null and channelName != ''" >
				channel_name = #{channelName,jdbcType=VARCHAR},
			</if>
			<if test="successAmount != null and successAmount != ''" >
				success_amount = #{successAmount,jdbcType=DECIMAL},
			</if>
			<if test="requestAmount != null" >
				request_amount = #{requestAmount,jdbcType=DECIMAL},
			</if>
			<if test="checkBathno != null" >
				check_bath_no = #{checkBathno,jdbcType=VARCHAR},
			</if>
			<if test="settleBath != null" >
				settle_bath = #{settleBath,jdbcType=VARCHAR},
			</if>
			<if test="channelType != null" >
				channel_type = #{channelType,jdbcType=VARCHAR},
			</if>
			<if test="productCode != null" >
				product_code = #{productCode,jdbcType=VARCHAR},
			</if>
			<if test="productName != null" >
				product_name = #{productName,jdbcType=VARCHAR},
			</if>
			<if test="channleNo != null" >
				channle_no = #{channleNo,jdbcType=VARCHAR},
			</if>
			<if test="differType != null" >
				differ_type = #{differType,jdbcType=VARCHAR},
			</if>
			<if test="handleResult != null" >
				handle_result = #{handleResult,jdbcType=VARCHAR},
			</if>
			<if test="handleMessage != null" >
				handle_message = #{handleMessage,jdbcType=VARCHAR},
			</if>
			<if test="errorDate != null" >
				error_date = #{errorDate,jdbcType=TIMESTAMP},
			</if>
			<if test="updateAuthor != null" >
				update_author = #{updateAuthor,jdbcType=VARCHAR},
			</if>
			<if test="operationDate != null" >
				operation_date = #{operationDate,jdbcType=TIMESTAMP},
			</if>
			<if test="feeAmount != null" >
				fee_amount = #{feeAmount,jdbcType=DECIMAL},
			</if>
			<if test="costAmount != null" >
				cost_amount = #{costAmount,jdbcType=DECIMAL},
			</if>
			<if test="settleAmountPlan != null" >
				settle_amount_plan = #{settleAmountPlan,jdbcType=DECIMAL},
			</if>
			<if test="transType != null" >
				trans_type = #{transType,jdbcType=VARCHAR},
			</if>
			<if test="transStatus != null" >
				trans_status = #{transStatus,jdbcType=VARCHAR},
			</if>
			<if test="isBill != null" >
				is_bill = #{isBill,jdbcType=VARCHAR},
			</if>
			<if test="isProfit != null" >
				is_profit = #{isProfit,jdbcType=VARCHAR},
			</if>
			<if test="merchantOrderNo != null" >
				merchant_order_no = #{merchantOrderNo,jdbcType=VARCHAR},
			</if>
			<if test="successTime != null" >
				success_time = #{successTime,jdbcType=TIMESTAMP},
			</if>
			<if test="payTime != null" >
				pay_time = #{payTime,jdbcType=TIMESTAMP},
			</if>
			<if test="busiTime != null" >
				busi_time = #{busiTime,jdbcType=TIMESTAMP},
			</if>
			<if test="remark != null and remark != ''" >
				remark = #{remark,jdbcType=VARCHAR},
			</if>
			<if test="isZip != null and isZip != ''" >
				is_zip = #{isZip,jdbcType=VARCHAR},
			</if>
			<if test="agentName != null and agentName != ''" >
				agent_name = #{agentName,jdbcType=VARCHAR},
			</if>
			<if test="agentCode != null" >
				agent_code = #{agentCode,jdbcType=BIGINT},
			</if>
			<if test="feeWay != null and feeWay != ''" >
				fee_way = #{feeWay,jdbcType=VARCHAR},
			</if>
			<if test="bankcardType != null and bankcardType != ''" >
				bankcard_type = #{bankcardType,jdbcType=VARCHAR},
			</if>
			<if test="merchantName != null and merchantName != ''">
				merchant_name = #{merchantName,jdbcType=VARCHAR},
			</if>
			<if test="bankSeq != null and bankSeq != ''" >
				bank_seq = #{bankSeq,jdbcType=VARCHAR},
			</if>
			<if test="bankName != null and bankName != ''" >
				bank_name = #{bankName,jdbcType=VARCHAR},
			</if>
			<if test="bankCode != null and bankCode != ''" >
				bank_code = #{bankCode,jdbcType=VARCHAR},
			</if>
			<if test="channelProvider != null and channelProvider != ''" >
				channel_provider = #{channelProvider,jdbcType=VARCHAR},
			</if>
			<if test="payType != null and payType != ''" >
				pay_type = #{payType,jdbcType=VARCHAR},
			</if>
			<if test="accountNo != null and accountNo != ''" >
				account_no = #{accountNo,jdbcType=VARCHAR},
			</if>
			<if test="receiptsPath != null and receiptsPath != ''" >
				receipts_path = #{receiptsPath,jdbcType=VARCHAR},
			</if>
		</set>
		where differ_id = #{differId,jdbcType=BIGINT}
	</update>

	<select id="getTransTypeByTransNo" resultType="SettleDifferRecord">
		SELECT
		DISTINCT trans_type
		FROM settle_differ_record
		WHERE trans_no=#{transNo}
	</select>

	<!--新增分页查询-->
	<select id="getListByPage" resultType="SettleDifferRecord">
		SELECT
		<include refid="settleDifferRecordColumns"/>
		FROM settle_differ_record
		<where>
			differ_type = #{differType} AND handle_result = #{handleResult} AND check_bath_no IS NULL AND settle_bath LIKE #{settleBath} AND trans_type IN ('CHARGE','PAYMNT','WZDRAW','BATPAY','REFUND')
			<!-- 通道对账日期 -->
			<if test="beginCheckTime != null and endCheckTime != null">
				AND error_date BETWEEN date_format(#{beginCheckTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCheckTime},'%Y-%m-%d %H:%i:%s')
			</if>
			<!-- 通道名称 -->
			<if test="channelName != null and channelName != ''">
				AND channel_name LIKE #{channelName}
			</if>

			<!-- 通道合作方-->
			<if test="channelCode != null and channelCode != ''">
				AND channel_code = #{channelCode}
			</if>
			<!-- 通道类型 -->
			<if test="channelType != null and channelType != ''">
				AND channel_type = #{channelType}
			</if>
			<!-- 交易类型 -->
			<if test="transType != null and transType != ''">
				AND trans_type = #{transType}
			</if>

			<!-- 支付单号-->
			<if test="paymentId != null and paymentId != ''">
				AND payment_id = #{paymentId}
			</if>
			<!-- 汇付宝订单号 -->
			<if test="transNo != null and transNo != ''">
				AND trans_no = #{transNo}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY differ_id DESC , #{page.orderBy}
			</when>
			<otherwise>
				ORDER BY differ_id DESC
			</otherwise>
		</choose>
	</select>


	<!--重构分页方法-->
	<select id="differRecordPage" resultType="SettleDifferRecord">
		SELECT
		<include refid="settleDifferRecordColumns"/>
		FROM settle_differ_record
		<where>
			<!-- 通道对账日期 -->
			<if test="beginCheckTime != null and endCheckTime != null">
				AND error_date BETWEEN date_format(#{beginCheckTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCheckTime},'%Y-%m-%d %H:%i:%s')
			</if>
			<!-- 通道名称 -->
			<if test="channelName != null and channelName != ''">
				AND channel_name LIKE #{channelName}
			</if>

			<!-- 通道合作方-->
			<if test="channelCode != null and channelCode != ''">
				AND channel_code = #{channelCode}
			</if>
			<!-- 通道类型 -->
			<if test="channelType != null and channelType != ''">
				AND channel_type = #{channelType}
			</if>
			<!-- 交易类型 -->
			<if test="transType != null and transType != ''">
				AND trans_type = #{transType}
			</if>
			<!-- 差错类型 -->
			<if test="differType != null and differType != ''">
				AND differ_type = #{differType}
			</if>
			<!-- 支付单号-->
			<if test="paymentId != null and paymentId != ''">
				AND payment_id = #{paymentId}
			</if>
			<!-- 汇付宝订单号 -->
			<if test="transNo != null and transNo != ''">
				AND trans_no = #{transNo}
			</if>
			<!-- 对账批次号 -->
			<if test="checkBathno != null and checkBathno != ''">
				AND check_bath_no = #{checkBathno}
			</if>

			<!-- 处理意见 -->
			<if test="handleMessage != null and handleMessage != ''">
				AND handle_message = #{handleMessage}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY differ_id DESC , #{page.orderBy}
			</when>
			<otherwise>
				ORDER BY differ_id DESC
			</otherwise>
		</choose>
	</select>
	<select id="getSettleDifferRecordByTransNo" resultType="SettleDifferRecord">
		SELECT
		<include refid="settleDifferRecordColumns"/>
		FROM settle_differ_record
		WHERE trans_no=#{transNo}
	</select>

</mapper>
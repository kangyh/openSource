<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heepay.manage.modules.settle.dao.ClearingMerchantRecordDao">
    
    <!-- 数据表中的字段对应翻译为实体类中对应的字段 -->
	<sql id="clearingMerchantRecordColumns">
		a.clearing_id AS "clearingId",
		a.merchant_id AS "merchantId",
		a.merchant_type AS "merchantType",
		a.product_code AS "productCode",
		a.product_name AS "productName",
		a.currency AS "currency",
		a.trans_no AS "transNo",
		a.trans_no_old AS "transNoOld",
		a.request_amount AS "requestAmount",
		a.success_time AS "successTime",
		a.settle_time AS "settleTime",
		a.settle_no AS "settleNo",
		a.settle_time_plan AS "settleTimePlan",
		a.settle_amount_plan AS "settleAmountPlan",
		a.settle_cyc AS "settleCyc",
		a.settle_bath AS "settleBath",
		a.fee_time AS "feeTime",
		a.fee AS "fee",
		a.fee_way AS "feeWay",
		a.fee_settle_cyc AS "feeSettleCyc",
		a.check_status AS "checkStatus",
		a.check_flg AS "checkFlg",
		a.settle_status AS "settleStatus",
		a.finish_time AS "finishTime",
		a.check_bath AS "checkBath",
		a.check_num AS "checkNum",
		a.trans_type AS "transType",
		a.is_profit AS "isProfit",
		a.merchant_order_no AS "merchantOrderNo",
		a.busi_time AS "busiTime",
		a.remark AS "remark",
		a.is_zip AS "isZip",
		a.agent_name AS "agentName",
		a.agent_code AS "agentCode",
		a.bankcard_type AS "bankcardType",
		a.merchant_name AS "merchantName",
		a.pay_type AS "payType",
		a.create_time AS "createTime",
		a.account_no AS "accountNo",
		a.pay_time AS "payTime"
	</sql>
	
	<!-- 
		修改条件是请同时修改下面的文件导出的查询条件
		findListToExcel
	 -->
	<select id="findList" resultType="ClearingMerchantRecord">
		SELECT 
			<include refid="clearingMerchantRecordColumns"/>
		FROM clearing_merchant_record a
		<where>
			<!--商户标记（内部：inside,外部：outsid）-->
			<if test="merchantFlag != null and merchantFlag != ''">
				AND a.merchant_id in
				<foreach item="item" index="index" collection="merchantFlagList" open="(" separator="," close=")">
					${item}
				</foreach>
			</if>
			<!-- 成功支付时间 -->
			<if test="beginCheckTime != null and endCheckTime != null">
				AND success_time BETWEEN date_format(#{beginCheckTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCheckTime},'%Y-%m-%d %H:%i:%s')
			</if>

			<!--交易类型-->
			<if test="transType != null and transType != ''">
				AND a.trans_type = #{transType}
			</if>
			<!-- 对账状态-->
			<if test="checkStatus != null and checkStatus != ''">
				AND a.check_status = #{checkStatus}
			</if>
			<!-- 结算状态-->
			<if test="settleStatus != null and settleStatus != ''">
				AND a.settle_status = #{settleStatus}
			</if>
			<!-- 用户编码 -->
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_Id = #{merchantId}
			</if>
			<!-- 对账标记-->
			<if test="checkFlg != null and checkFlg != ''">
				<choose>
					<when test="checkFlg == 'QSTS'">
						AND a.check_flg = #{checkFlg}
					</when>
					<otherwise>
						AND a.check_flg in (SELECT check_flg FROM clearing_merchant_record where check_flg is not null and check_flg != 'QSTS')
					</otherwise>
				</choose>
			</if>
			<!-- 交易订单号-->
			<if test="transNo != null and transNo != ''">
				AND a.trans_no = #{transNo}
			</if>
			<!-- 结算批次号-->
			<if test="settleBath != null and settleBath != ''">
				AND a.settle_bath = #{settleBath}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY clearing_id desc
			</otherwise>
		</choose>
	</select>

	<!--金额汇总-->
	<select id="sumNum" resultType="ClearingMerchantRecord">
		SELECT
			SUM(request_amount) AS "sumRequestAmount",
			SUM(settle_amount_plan) AS "sumSettleAmountPlan",
			SUM(fee) AS "sumFee"
		FROM clearing_merchant_record a
		<where>
			<!--商户标记（内部：inside,外部：outsid）-->
			<if test="merchantFlag != null and merchantFlag != ''">
				AND a.merchant_id in
				<foreach item="item" index="index" collection="merchantFlagList" open="(" separator="," close=")">
					${item}
				</foreach>
			</if>
			<!-- 成功支付时间 -->
			<if test="beginCheckTime != null and endCheckTime != null">
				AND success_time BETWEEN date_format(#{beginCheckTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCheckTime},'%Y-%m-%d %H:%i:%s')
			</if>

			<!--交易类型-->
			<if test="transType != null and transType != ''">
				AND a.trans_type = #{transType}
			</if>
			<!-- 对账状态-->
			<if test="checkStatus != null and checkStatus != ''">
				AND a.check_status = #{checkStatus}
			</if>
			<!-- 结算状态-->
			<if test="settleStatus != null and settleStatus != ''">
				AND a.settle_status = #{settleStatus}
			</if>
			<!-- 用户编码 -->
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_Id = #{merchantId}
			</if>
			<!-- 对账标记-->
			<if test="checkFlg != null and checkFlg != ''">
				<choose>
					<when test="checkFlg == 'QSTS'">
						AND a.check_flg = #{checkFlg}
					</when>
					<otherwise>
						AND a.check_flg in (SELECT check_flg FROM clearing_merchant_record where check_flg is not null and check_flg != 'QSTS')
					</otherwise>
				</choose>
			</if>
			<!-- 交易订单号-->
			<if test="transNo != null and transNo != ''">
				AND a.trans_no = #{transNo}
			</if>
			<!-- 结算批次号-->
			<if test="settleBath != null and settleBath != ''">
				AND a.settle_bath = #{settleBath}
			</if>
		</where>
	</select>
	
	<!-- 导出商户侧清算记录文件专用SQL -->
	<select id="findListToExcel" resultType="hashmap">
		SELECT 
			<include refid="clearingMerchantRecordColumns"/>
		FROM clearing_merchant_record a
		<where>
			<!--商户标记（内部：inside,外部：outsid）-->
			<if test="merchantFlag != null and merchantFlag != ''">
				AND a.merchant_id in
				<foreach item="item" index="index" collection="merchantFlagList" open="(" separator="," close=")">
					${item}
				</foreach>
			</if>
			<!-- 成功支付时间 -->
			<if test="beginCheckTime != null and endCheckTime != null">
				AND success_time BETWEEN date_format(#{beginCheckTime},'%Y-%m-%d %H:%i:%s') AND date_format(#{endCheckTime},'%Y-%m-%d %H:%i:%s')
			</if>

			<!--交易类型-->
			<if test="transType != null and transType != ''">
				AND a.trans_type = #{transType}
			</if>
			<!-- 对账状态-->
			<if test="checkStatus != null and checkStatus != ''">
				AND a.check_status = #{checkStatus}
			</if>
			<!-- 结算状态-->
			<if test="settleStatus != null and settleStatus != ''">
				AND a.settle_status = #{settleStatus}
			</if>
			<!-- 用户编码 -->
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_Id = #{merchantId}
			</if>
			<!-- 对账标记-->
			<if test="checkFlg != null and checkFlg != ''">
				<choose>
					<when test="checkFlg == 'QSTS'">
						AND a.check_flg = #{checkFlg}
					</when>
					<otherwise>
						AND a.check_flg in (SELECT check_flg FROM clearing_merchant_record where check_flg is not null and check_flg != 'QSTS')
					</otherwise>
				</choose>
			</if>
			<!-- 交易订单号-->
			<if test="transNo != null and transNo != ''">
				AND a.trans_no = #{transNo}
			</if>
			<!-- 结算批次号-->
			<if test="settleBath != null and settleBath != ''">
				AND a.settle_bath = #{settleBath}
			</if>
		</where>
		ORDER BY a.clearing_id desc
	</select>
	
	<!-- 通过交易单号查询业务类型 -->
	<select id="getTransType" resultType="String" parameterType="String">
		SELECT trans_type  FROM clearing_merchant_record WHERE trans_no=#{transNo}
	</select>
	
	<!-- 商户侧结算信息详情专用SQL -->
	<select id="findPageDetail" resultType="ClearingMerchantRecord">
		SELECT 
			<include refid="clearingMerchantRecordColumns"/>
		FROM clearing_merchant_record a
		<where>
			<!-- 结算批次号-->
			<if test="settleBath != null and settleBath != ''">
				AND a.settle_bath = #{settleBath}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY clearing_id desc
			</otherwise>
		</choose>
	</select>
	
	<!-- 清结算财务报表 -->
	<select id="findReportList" resultType="ClearingMerchantRecord">
		SELECT 
			<if test="groupby != null and groupby == 'channel'">
				c.channel_code AS "channelCode",
				c.channel_name AS "channelName",
				c.bank_name AS "bankName",
				a.pay_type AS "payType",
			</if>
			<if test="groupby != null and groupby == 'merchant'">
				a.merchant_id AS "merchantId",
				a.merchant_name AS "merchantName",
			</if>
			<if test="groupby != null and groupby == 'paytype'">
				a.pay_type AS "payType",
			</if>
			<if test="groupby != null and groupby == 'merchantAndPayType'">
				a.pay_type AS "payType",
				a.merchant_id AS "merchantId",
				a.merchant_name AS "merchantName",
			</if>
			count(1) AS "countNum",
			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) END) AS "settleAmount",
  			(CASE WHEN SUM(a.request_amount) IS NULL THEN 0.0000 ELSE SUM(a.request_amount) END) AS "successAmount",
  			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) END) AS "feeAmount" 
		FROM clearing_merchant_record a 
		INNER JOIN clearing_channel_record c ON c.trans_no = a.trans_no
		<where>
			<!-- 结算日期 -->
			<if test="beginSettleTime != null">
				<![CDATA[   and DATE_FORMAT(a.success_time, '%Y-%m-%d')>=  DATE_FORMAT(#{beginSettleTime}, '%Y-%m-%d')   ]]>
			</if>
			<if test="endSettleTime != null">
				<![CDATA[  and DATE_FORMAT(a.success_time, '%Y-%m-%d') <= DATE_FORMAT(#{endSettleTime}, '%Y-%m-%d')    ]]>
			</if>
			<!--支付类型-->
			<if test="payType != null and payType != ''">
				AND a.pay_type = #{payType}
			</if>
			<!-- 商户ID-->
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
			<!-- 商户名称-->
			<if test="merchantName != null and merchantName != ''">
				AND a.merchant_name = #{merchantName}
			</if>
			<!-- 银行卡类型 -->
			<if test="bankcardType != null and bankcardType != ''">
				AND a.bankcard_type = #{bankcardType}
			</if>
			<!-- 通道Code -->
			<if test="channelName != null and channelName != ''">
				AND c.channel_name = #{channelName}
			</if>
			<!-- 银行Code -->
			<if test="bankCode != null and bankCode != ''">
				AND c.bank_code = #{bankCode}
			</if>
			AND a.check_flg = 'QSTS'
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				<!-- ORDER BY clearing_id desc -->
			</otherwise>
		</choose>
		<if test="groupby != null and groupby == 'channel'">
			GROUP BY c.channel_code,c.channel_name,c.bank_name,a.pay_type
		</if>
		<if test="groupby != null and groupby == 'merchant'">
			GROUP BY a.merchant_id,a.merchant_name
		</if>
		<if test="groupby != null and groupby == 'paytype'">
			GROUP BY a.pay_type
		</if>
		<if test="groupby != null and groupby == 'merchantAndPayType'">
			GROUP BY a.pay_type,a.merchant_id,a.merchant_name
		</if>
	</select>
	
	<!-- 清结算财务报表 -->
	<select id="findListToReportExcel" resultType="hashmap">
		SELECT 
			<if test="groupby != null and groupby == 'channel'">
				c.channel_code AS "channelCode",
				c.channel_name AS "channelName",
				c.bank_name AS "bankName",
				a.pay_type AS "payType",
			</if>
			<if test="groupby != null and groupby == 'merchant'">
				a.merchant_id AS "merchantId",
				a.merchant_name AS "merchantName",
			</if>
			<if test="groupby != null and groupby == 'paytype'">
				a.pay_type AS "payType",
			</if>
			<if test="groupby != null and groupby == 'merchantAndPayType'">
				a.pay_type AS "payType",
				a.merchant_id AS "merchantId",
				a.merchant_name AS "merchantName",
			</if>
			count(1) AS "countNum",
			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) END) AS "settleAmount",
  			(CASE WHEN SUM(a.request_amount) IS NULL THEN 0.0000 ELSE SUM(a.request_amount) END) AS "successAmount",
  			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) END) AS "feeAmount" 
		FROM clearing_merchant_record a 
		INNER JOIN clearing_channel_record c ON c.trans_no = a.trans_no
		<where>
			<!-- 结算日期 -->
			<if test="beginSettleTime != null">
				<![CDATA[   and DATE_FORMAT(a.success_time, '%Y-%m-%d')>=  DATE_FORMAT(#{beginSettleTime}, '%Y-%m-%d')   ]]>
			</if>
			<if test="endSettleTime != null">
				<![CDATA[  and DATE_FORMAT(a.success_time, '%Y-%m-%d') <= DATE_FORMAT(#{endSettleTime}, '%Y-%m-%d')    ]]>
			</if>
			<!--支付类型-->
			<if test="payType != null and payType != ''">
				AND a.pay_type = #{payType}
			</if>
			<!-- 商户ID-->
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
			<!-- 商户名称-->
			<if test="merchantName != null and merchantName != ''">
				AND a.merchant_name = #{merchantName}
			</if>
			<!-- 银行卡类型 -->
			<if test="bankcardType != null and bankcardType != ''">
				AND a.bankcard_type = #{bankcardType}
			</if>
			<!-- 通道Name -->
			<if test="channelName != null and channelName != ''">
				AND c.channel_name = #{channelName}
			</if>
			<!-- 银行Code -->
			<if test="bankCode != null and bankCode != ''">
				AND c.bank_code = #{bankCode}
			</if>
			AND a.check_flg = 'QSTS'
		</where>
		<if test="groupby != null and groupby == 'channel'">
			GROUP BY c.channel_code,c.channel_name,c.bank_name,a.pay_type
		</if>
		<if test="groupby != null and groupby == 'merchant'">
			GROUP BY a.merchant_id,a.merchant_name
		</if>
		<if test="groupby != null and groupby == 'paytype'">
			GROUP BY a.pay_type
		</if>
		<if test="groupby != null and groupby == 'merchantAndPayType'">
			GROUP BY a.pay_type,a.merchant_id,a.merchant_name
		</if>
	</select>
	
	
	<!-- 清结算运营报表 -->
	<select id="findDetailPage" resultType="ClearingMerchantRecord">
		SELECT 
			a.merchant_id AS "merchantId",
			a.trans_type AS "transType",
			a.product_name AS "productName",
			a.merchant_name AS "merchantName",
			
			
			count(1) AS "countNum",
			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) END) AS "settleAmount",
  			(CASE WHEN SUM(a.request_amount) IS NULL THEN 0.0000 ELSE SUM(a.request_amount) END) AS "successAmount",
  			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) END) AS "feeAmount" 
		FROM clearing_merchant_record a 
		
		<where>
			<!-- 结算日期 -->
			<if test="beginSettleTime != null">
				<![CDATA[   and DATE_FORMAT(a.success_time, '%Y-%m-%d')>=  DATE_FORMAT(#{beginSettleTime}, '%Y-%m-%d')   ]]>
			</if>
			<if test="endSettleTime != null">
				<![CDATA[  and DATE_FORMAT(a.success_time, '%Y-%m-%d') <= DATE_FORMAT(#{endSettleTime}, '%Y-%m-%d')    ]]>
			</if>
			<!--支付类型-->
			<if test="transType != null and transType != ''">
				AND a.trans_type = #{transType}
			</if>
			<!-- 商户ID-->
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
			<!-- 商户名称-->
			<if test="merchantName != null and merchantName != ''">
				AND a.merchant_name = #{merchantName}
			</if>
			<!-- 银行卡类型 -->
			<if test="bankcardType != null and bankcardType != ''">
				AND a.bankcard_type = #{bankcardType}
			</if>
			<!-- 产品名称 -->
			<!-- <if test="productName != null and productName != ''">
				AND a.product_name = #{productName}
			</if> -->
			<!-- 产品编码 -->
			<if test="productCode != null and productCode != ''">
				AND a.product_code = #{productCode}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				<!-- ORDER BY clearing_id desc -->
			</otherwise>
		</choose>
		
			GROUP BY a.trans_type,a.merchant_id,a.product_name,a.merchant_name
		
	</select>
	
	
	<!-- 清结算运营报表 -->
	<select id="findListDetailReportExcel" resultType="hashmap">
		SELECT 
			a.merchant_id AS "merchantId",
			a.trans_type AS "transType",
			a.product_name AS "productName",
			a.merchant_name AS "merchantName",
			
			
			count(1) AS "countNum",
			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.settle_amount_plan ELSE a.request_amount END) END) AS "settleAmount",
  			(CASE WHEN SUM(a.request_amount) IS NULL THEN 0.0000 ELSE SUM(a.request_amount) END) AS "successAmount",
  			(CASE WHEN SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) IS NULL THEN 0.0000 ELSE SUM(CASE WHEN a.fee_way = 'INDEDU' THEN a.fee ELSE 0 END) END) AS "feeAmount" 
		FROM clearing_merchant_record a 
		
		<where>
			<!-- 结算日期 -->
			<if test="beginSettleTime != null">
				<![CDATA[   and DATE_FORMAT(a.success_time, '%Y-%m-%d')>=  DATE_FORMAT(#{beginSettleTime}, '%Y-%m-%d')   ]]>
			</if>
			<if test="endSettleTime != null">
				<![CDATA[  and DATE_FORMAT(a.success_time, '%Y-%m-%d') <= DATE_FORMAT(#{endSettleTime}, '%Y-%m-%d')    ]]>
			</if>
			<!--支付类型-->
			<if test="transType != null and transType != ''">
				AND a.trans_type = #{transType}
			</if>
			<!-- 商户ID-->
			<if test="merchantId != null and merchantId != ''">
				AND a.merchant_id = #{merchantId}
			</if>
			<!-- 商户名称-->
			<if test="merchantName != null and merchantName != ''">
				AND a.merchant_name = #{merchantName}
			</if>
			<!-- 银行卡类型 -->
			<if test="bankcardType != null and bankcardType != ''">
				AND a.bankcard_type = #{bankcardType}
			</if>
			<!-- 产品名称 -->
			<!-- <if test="productName != null and productName != ''">
				AND a.product_name = #{productName}
			</if> -->
			<!-- 产品编码 -->
			<if test="productCode != null and productCode != ''">
				AND a.product_code = #{productCode}
			</if>
		</where>
			GROUP BY a.trans_type,a.merchant_id,a.product_name,a.merchant_name
	</select>

	<select id="getEntityById" resultType="ClearingMerchantRecord">
		SELECT
		<include refid="clearingMerchantRecordColumns"/>
		FROM clearing_merchant_record a
		WHERE a.clearing_id = #{clearingId}
	</select>

	<select id="getEntity" resultType="ClearingMerchantRecord">
		SELECT
		<include refid="clearingMerchantRecordColumns"/>
		FROM clearing_merchant_record a
		WHERE a.trans_type = #{transType} AND a.trans_no = #{transNo}
	</select>
</mapper>